<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      type="image/x-icon"
      href="../assets/img/logo.png"
      rel="shortcut icon"
    />
    <!-- favicon Logo -->

    <title>Thông tin cá nhân</title>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      .profile-container {
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .profile-card {
        padding: 20px;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
      }

      .profile-info {
        text-align: left;
        margin-top: 20px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #ddd;
      }

      button#edit-profile {
        background: #4a90e2;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        margin-top: 15px;
        cursor: pointer;
      }

      button#edit-profile:hover {
        background: #357abd;
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetchUserProfile();
      });

      function fetchUserProfile() {
        fetch(`http://localhost:5000/api/users/profile`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            authorization: `Bearer ${localStorage.getItem("token")}`, // Gửi token để xác thực
          },
        })
          .then((response) => response.json())
          .then((user) => {
            document.getElementById("avatar").src =
              user.avatar || "../assets/img/default_avata.png";
            document.getElementById("name").textContent = user.name;
            document.getElementById("phone").textContent = user.phone;
            document.getElementById("email").textContent = user.email;
            document.getElementById("sex").textContent =
              user.sex || "Chưa cập nhật";
            document.getElementById("dob").textContent = new Date(
              user.dOB
            ).toLocaleDateString("vi-VN");
          })
          .catch((error) => console.error("Lỗi khi lấy dữ liệu:", error));
      }

      // Chức năng chỉnh sửa
      document.getElementById("edit-profile").addEventListener("click", () => {
        window.location.href = "edit-profile.html"; // Chuyển đến trang chỉnh sửa
      });
    </script>
  </head>
  <body>
    <div data-include="../components/header.html"></div>
    <!-- Nhúng Header -->

    <main>
      <div class="profile-container">
        <h2>Thông tin cá nhân</h2>
        <div class="profile-card">
          <img
            id="avatar"
            src="../assets/img/default_avatar.png"
            alt="Ảnh đại diện"
            class="profile-avatar"
          />
          <div class="profile-info">
            <div class="info-row">
              <span>Họ và tên</span>
              <span id="name">Loading...</span>
            </div>
            <div class="info-row">
              <span>Số điện thoại</span>
              <span id="phone">Loading...</span>
            </div>
            <div class="info-row">
              <span>Email</span>
              <span id="email">Loading...</span>
            </div>
            <div class="info-row">
              <span>Giới tính</span>
              <span id="sex">Loading...</span>
            </div>
            <div class="info-row">
              <span>Ngày sinh</span>
              <span id="dob">Loading...</span>
            </div>
          </div>
          <button id="edit-profile">Chỉnh sửa thông tin</button>
          <button id="edit-address">Chỉnh sửa sổ địa chỉ</button>
        </div>
      </div>

      <!-- Modal -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="modal-title">Chỉnh sửa thông tin</h2>
          <form id="edit-form">
            <label for="edit-name">Họ và tên:</label>
            <input type="text" id="edit-name" name="name" />

            <label for="edit-phone">Số điện thoại:</label>
            <input type="text" id="edit-phone" name="phone" />

            <label for="edit-email">Email:</label>
            <input type="email" id="edit-email" name="email" />

            <label for="edit-sex">Giới tính:</label>
            <select id="edit-sex" name="sex">
              <option value="Nam">Nam</option>
              <option value="Nữ">Nữ</option>
              <option value="Khác">Khác</option>
            </select>

            <label for="edit-dob">Ngày sinh:</label>
            <input type="date" id="edit-dob" name="dob" />

            <button type="submit">Lưu</button>
          </form>
        </div>
      </div>

      <!-- Modal Chỉnh sửa Sổ Địa Chỉ -->
      <div id="addressModal" class="modal">
        <div class="modal-content">
          <span class="close close-address">&times;</span>
          <h2>Quản lý Sổ Địa Chỉ</h2>
          <div class="address-container">
            <div class="address-list">
              <h3>Danh sách địa chỉ</h3>
              <ul id="address-items"></ul>
              <button id="add-address" class="btn">+ Thêm địa chỉ mới</button>
            </div>
            <div class="address-form">
              <h3>Chỉnh sửa địa chỉ</h3>
              <form id="address-form">
                <label for="edit-address">Địa chỉ:</label>
                <input type="text" id="edit-address" name="address" required />

                <label for="edit-phoneToDelivery"
                  >Số điện thoại nhận hàng:</label
                >
                <input
                  type="text"
                  id="edit-phoneToDelivery"
                  name="phoneToDelivery"
                  required
                />

                <label class="checkbox-container">
                  <input
                    type="checkbox"
                    id="edit-default-address"
                    name="default"
                  />
                  Đặt làm địa chỉ mặc định
                </label>

                <div class="form-actions">
                  <button type="submit" class="btn save">Lưu</button>
                  <button type="button" id="delete-address" class="btn delete">
                    Xóa
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div data-include="../components/footer.html"></div>
    <!-- Nhúng Footer -->
    <style>
      /* Ẩn modal ban đầu */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      /* Nội dung modal */
      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      /* Nút đóng modal */
      .close {
        float: right;
        font-size: 20px;
        cursor: pointer;
      }

      /* Các input */
      input,
      select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      /* Nút submit */
      button {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 10px;
        width: 100%;
        border-radius: 5px;
        cursor: pointer;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .address-container {
        display: flex;
        gap: 20px;
      }
      .address-list {
        width: 40%;
        border-right: 2px solid #eee;
        padding-right: 20px;
      }
      .address-form {
        width: 60%;
      }
      #address-items li {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        transition: background 0.2s;
      }
      #address-items li:hover {
        background-color: #e6f7ff;
      }
      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn.save {
        background-color: #28a745;
        color: white;
      }
      .btn.delete {
        background-color: #dc3545;
        color: white;
      }
      .btn:hover {
        opacity: 0.8;
      }
      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
    </style>

    <script src="../assets/js/main.js"></script>
    <!-- Import file JS -->

    <script>
      //Load data tên người dùng, số điện thoại, email, giới tính, ngày sinh khi nhấn vào nút chỉnh sửa thông tin
      //Load data user profile
      function fetchUserProfileModal() {
        const profileModal = document.getElementById("editModal");

        const inputName = document.getElementById("edit-name");
        const inputPhone = document.getElementById("edit-phone");
        const inputEmail = document.getElementById("edit-email");

        inputName.setAttribute(
          "value",
          document.getElementById("name").textContent
        );
        inputPhone.setAttribute(
          "value",
          document.getElementById("phone").textContent
        );
        inputEmail.setAttribute(
          "value",
          document.getElementById("email").textContent
        );
        const dobText = document.getElementById("dob").textContent.trim();
        const parts = dobText.split("/");
        if (parts.length === 3) {
          const formattedDOB = `${parts[2]}-${parts[1]}-${parts[0]}`; // Chuyển thành YYYY-MM-DD
          document.getElementById("edit-dob").value = formattedDOB;
        }

        const inputSex = document.getElementById("edit-sex");
        inputSex.value = document.getElementById("sex").textContent.trim();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const profileModal = document.getElementById("editModal");
        const addressModal = document.getElementById("addressModal");
        const closeProfileModal = document.querySelector(".close");
        const closeAddressModal = document.querySelector(".close-address");
        const editProfileBtn = document.getElementById("edit-profile");
        const editAddressBtn = document.getElementById("edit-address");

        // Kiểm tra xem các phần tử có tồn tại không trước khi thêm sự kiện
        if (editProfileBtn && profileModal) {
          editProfileBtn.addEventListener("click", () => {
            profileModal.style.display = "flex";
            fetchUserProfileModal();
          });
        }

        if (editAddressBtn && addressModal) {
          editAddressBtn.addEventListener("click", () => {
            addressModal.style.display = "flex";
          });
        }

        if (closeProfileModal && profileModal) {
          closeProfileModal.addEventListener("click", () => {
            profileModal.style.display = "none";
          });
        }

        if (closeAddressModal && addressModal) {
          closeAddressModal.addEventListener("click", () => {
            addressModal.style.display = "none";
          });
        }

        // Đóng modal khi click ra ngoài
        window.addEventListener("click", (event) => {
          if (profileModal && event.target === profileModal) {
            profileModal.style.display = "none";
          }
          if (addressModal && event.target === addressModal) {
            addressModal.style.display = "none";
          }
        });
        // Xử lý gửi form chỉnh sửa thông tin
        const editForm = document.getElementById("edit-form");
        if (editForm) {
          editForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const newProfile = {
              name: document.getElementById("edit-name").value.trim(),
              phone: document.getElementById("edit-phone").value.trim(),
              email: document.getElementById("edit-email").value.trim(),
              sex: document.getElementById("edit-sex").value,
              dOB: document.getElementById("edit-dob").value, // Ngày sinh đã ở dạng YYYY-MM-DD
            };

            fetch("http://localhost:5000/api/users/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify(newProfile),
            })
              .then((response) => response.json())
              .then((data) => {
                alert("Cập nhật thông tin thành công!");
                document.getElementById("editModal").style.display = "none";
                fetchUserProfile(); // Cập nhật lại giao diện với dữ liệu mới
              })
              .catch((error) => {
                console.error("Lỗi khi cập nhật thông tin:", error);
                alert("Có lỗi xảy ra, vui lòng thử lại!");
              });
          });
        }

        // Xử lý gửi form địa chỉ
        document.addEventListener("DOMContentLoaded", () => {
            const addressList = document.getElementById("address-items");
            const editAddressForm = document.getElementById("address-form");
            let addresses = [];
        
            function loadAddresses() {
              fetch("http://localhost:5000/user/address", {
                headers: { authorization: `Bearer ${localStorage.getItem("token")}` }
              })
              .then(res => res.json())
              .then(data => {
                addresses = data;
                addressList.innerHTML = "";
                data.forEach((address, index) => {
                  const li = document.createElement("li");
                  li.textContent = address;
                  li.dataset.index = index;
                  li.addEventListener("click", () => fillAddressForm(index));
                  addressList.appendChild(li);
                });
              });
            }
        
            function fillAddressForm(index) {
              document.getElementById("edit-address").value = addresses[index] || "";
            }
        
            editAddressForm.addEventListener("submit", (event) => {
              event.preventDefault();
              const updatedAddresses = [...addresses];
              const editedAddress = document.getElementById("edit-address").value;
              updatedAddresses[selectedIndex] = editedAddress;
              
              fetch("http://localhost:5000/user/address", {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  authorization: `Bearer ${localStorage.getItem("token")}`
                },
                body: JSON.stringify({ address: updatedAddresses })
              })
              .then(res => res.json())
              .then(() => {
                alert("Cập nhật địa chỉ thành công!");
                loadAddresses();
              });
            });
        
            document.getElementById("add-address").addEventListener("click", () => {
              addresses.push("");
              loadAddresses();
            });
        
            loadAddresses();
          });
        });
    </script>
  </body>
</html>
