<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      type="image/x-icon"
      href="../assets/img/logo.png"
      rel="shortcut icon"
    />
    <title>Danh mục sản phẩm</title>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <script src="../assets/js/main.js"></script>
    <style>
      .category-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin: 20px 0;
      }

      .filter-sidebar {
        width: 250px;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .filter-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
      }

      .filter-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        color: #333;
      }

      .filter-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-option {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .filter-option input {
        margin-right: 8px;
      }

      .filter-option label {
        cursor: pointer;
        font-size: 14px;
        font-weight: 400;
      }

      .price-range-inputs {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .price-range-inputs input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .product-list {
        flex: 1;
      }

      .sort-options {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
        align-items: center;
        gap: 10px;
      }

      .sort-label {
        font-size: 14px;
        color: #333;
      }

      .sort-buttons {
        display: flex;
        gap: 10px;
      }

      .sort-button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .sort-button.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
      }

      .search-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
      }

      .search-card {
        border-radius: 15px;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .search-card:hover {
        border: 1px solid #007bff;
      }

      .product-image img {
        width: 100%;
        height: auto;
        border-radius: 10px;
      }

      .product-info h3 {
        font-size: 16px;
        margin: 10px 0 5px;
        font-weight: 500;
        line-clamp: 4;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.5em;
        height: 6em;
      }

      .price {
        color: #1250e2;
        font-weight: bold;
        text-align: end;
      }

      .add-to-cart {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 8px 15px;
        width: 100%;
        border-radius: 20px;
        cursor: pointer;
        display: block;
        margin-top: 10px;
        text-align: center;
        text-decoration: none;
      }

      .consult-button {
        background-color: #ff6b6b;
        color: #fff;
        border: none;
        padding: 8px 15px;
        width: 100%;
        border-radius: 20px;
        cursor: pointer;
        display: block;
        margin-top: 10px;
        text-align: center;
        text-decoration: none;
      }

      .product-link {
        text-decoration: none;
        color: inherit;
      }

      .listName{
        font-size: 20px;
        font-weight: 700;
        flex-grow: 1;
      }
    </style>
  </head>
  <body>
    <div data-include="../components/header.html"></div>
    <!-- Nhúng Header -->

    <main>
      <section class="category-page">
        <div class="container">
          <div class="category-container">
            <!-- Sidebar bộ lọc -->
            <div class="filter-sidebar">
              <div class="filter-section">
                <h3>Loại thuốc</h3>
                <div class="filter-options">
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="all-type"
                      name="medicine-type"
                      value="all"
                      checked
                    />
                    <label for="all-type">Tất cả</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="prescription"
                      name="medicine-type"
                      value="prescription"
                    />
                    <label for="prescription">Thuốc kê đơn</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="non-prescription"
                      name="medicine-type"
                      value="non-prescription"
                    />
                    <label for="non-prescription">Thuốc không kê đơn</label>
                  </div>
                </div>
              </div>

              <div class="filter-section">
                <h3>Giá bán</h3>
                <div class="filter-options">
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="price-all"
                      name="price-range"
                      value="all"
                      checked
                    />
                    <label for="price-all">Tất cả</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="price-1"
                      name="price-range"
                      value="0-10000"
                    />
                    <label for="price-1">Dưới 10.000đ</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="price-2"
                      name="price-range"
                      value="10000-100000"
                    />
                    <label for="price-2">10.000đ - 100.000đ</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="price-3"
                      name="price-range"
                      value="100000-200000"
                    />
                    <label for="price-3">100.000đ - 200.000đ</label>
                  </div>
                  <div class="filter-option">
                    <input
                      type="radio"
                      id="price-4"
                      name="price-range"
                      value="200000-"
                    />
                    <label for="price-4">Trên 200.000đ</label>
                  </div>
                </div>
              </div>

              <div class="filter-section">
                <h3>Nước sản xuất</h3>
                <div class="filter-options" id="manufacturer-options">
                  <!-- Sẽ được load bằng JS -->
                </div>
              </div>
            </div>

            <!-- Danh sách sản phẩm -->
            <div class="product-list">
              <div class="sort-options">
                <div class="listName"></div>
                <span class="sort-label">Sắp xếp theo</span>
                <div class="sort-buttons">
                  <button class="sort-button active" data-sort="popular">
                    Bán chạy
                  </button>
                  <button class="sort-button" data-sort="price-low">
                    Giá thấp
                  </button>
                  <button class="sort-button" data-sort="price-high">
                    Giá cao
                  </button>
                </div>
              </div>

              <div class="search-grid" id="productGrid"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div data-include="../components/Footer.html"></div>
    <!-- Nhúng Footer -->

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const category = new URLSearchParams(window.location.search).get(
          "category"
        );
        const productGrid = document.getElementById("productGrid");
        const sortButtons = document.querySelectorAll(".sort-button");

        const manufacturerOptions = document.getElementById(
          "manufacturer-options"
        );

        // State lọc
        let currentFilters = {
          medicineType: "all",
          priceRange: "all",
          countries: [],
          sort: "popular",
        };

        // Load danh sách manufacturers
        async function loadManufacturers() {
          const res = await fetch(
            "http://localhost:5000/api/products/manufacturers/" + category
          );
          const data = await res.json();

          // Lựa chọn tất cả
          const allCheckbox = document.createElement("div");
          allCheckbox.className = "filter-option";
          allCheckbox.innerHTML = `
          <input type="checkbox" id="country-all" checked>
          <label for="country-all">Tất cả</label>
        `;
          manufacturerOptions.appendChild(allCheckbox);

          document
            .getElementById("country-all")
            .addEventListener("change", function () {
              currentFilters.countries = [];
              manufacturerOptions
                .querySelectorAll('input[type="checkbox"]')
                .forEach((cb) => {
                  if (cb.id !== "country-all") cb.checked = false;
                });
              loadProducts();
            });

          // Render danh sách quốc gia
          data.forEach((name, i) => {
            const id = "country-" + i;
            const div = document.createElement("div");
            div.className = "filter-option";
            div.innerHTML = `
            <input type="checkbox" id="${id}" value="${name}">
            <label for="${id}">${name}</label>
          `;
            manufacturerOptions.appendChild(div);

            div.querySelector("input").addEventListener("change", function () {
              document.getElementById("country-all").checked = false;
              if (this.checked) {
                currentFilters.countries.push(this.value);
              } else {
                currentFilters.countries = currentFilters.countries.filter(
                  (c) => c !== this.value
                );
              }
              loadProducts();
            });
          });
        }

        // Load sản phẩm
        async function loadProducts() {
          // Hiển thị modal loading
          const loadingModal = document.createElement("div");
          loadingModal.id = "loadingModal";
          loadingModal.style.position = "fixed";
          loadingModal.style.top = "0";
          loadingModal.style.left = "0";
          loadingModal.style.width = "100%";
          loadingModal.style.height = "100%";
          loadingModal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
          loadingModal.style.display = "flex";
          loadingModal.style.justifyContent = "center";
          loadingModal.style.alignItems = "center";
          loadingModal.style.zIndex = "9999";
          loadingModal.style.visibility = "hidden";
          loadingModal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
              <p>Đang tải dữ liệu...</p>
              <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto"></div>
            </div>
          `;
          document.body.appendChild(loadingModal);

          // Thêm CSS cho spinner
          const style = document.createElement("style");
          //Thêm căn giữa spinner
          
          style.innerHTML = `
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);

          // Hiển thị modal khi tải dữ liệu
          loadingModal.style.visibility = "visible";

          try {
            // Thực hiện tải dữ liệu
            let listName = document.querySelector(".listName");
            listName.innerText = `${category}`;
            let url = `http://localhost:5000/api/products/groups/${category}`; // categoryId là tên nhóm thuốc (drugGroup)
            const params = new URLSearchParams();

            if (currentFilters.medicineType !== "all") {
              params.append("medicineType", currentFilters.medicineType);
            }

            if (currentFilters.priceRange !== "all") {
              params.append("priceRange", currentFilters.priceRange);
            }

            if (currentFilters.countries.length > 0) {
              params.append("countries", currentFilters.countries.join(","));
            }

            params.append("sort", currentFilters.sort);
            url += `?${params.toString()}`;

            const res = await fetch(url);
            const products = await res.json();
            productGrid.innerHTML = "";

            products.forEach((product) => {
              const price = product.packagingUnits?.[0]?.price || 0;
              const unit = product.packagingUnits?.[0]?.unitName || "";
              const isPrescription = product.isPrescription || false;

              const card = document.createElement("div");
              card.className = "search-card";

              card.innerHTML = `
              <a href="product-detail.html?id=${
                product._id || product.id
              }" class="product-link">
                <div class="product-image">
                  <img src="${
                    product.images || "https://via.placeholder.com/200x200"
                  }" alt="${product.name}" />
                </div>
                <div class="product-info">
                  <h3>${product.name}</h3>
                  <p class="price">${price.toLocaleString(
                    "vi-VN"
                  )}đ / <span>${unit}</span></p>
                </div>
              </a>
              ${
                isPrescription
                  ? `<button class="consult-button">Cần tư vấn từ dược sỹ</button>`
                  : `<button class="add-to-cart" data-product-id="${
                      product._id || product.id
                    }">Chọn mua</button>`
              }
            `;
              productGrid.appendChild(card);
            });
          } catch (error) {
            console.error("Lỗi khi tải sản phẩm:", error);
          } finally {
            // Ẩn modal loading sau khi tải xong
            loadingModal.style.visibility = "hidden";
          }
          
            let listName = document.querySelector(".listName");
            listName.innerText = `${category}`;
          let url = `http://localhost:5000/api/products/groups/${category}`; // categoryId là tên nhóm thuốc (drugGroup)
          const params = new URLSearchParams();

          if (currentFilters.medicineType !== "all") {
            params.append("medicineType", currentFilters.medicineType);
          }

          if (currentFilters.priceRange !== "all") {
            params.append("priceRange", currentFilters.priceRange);
          }

          if (currentFilters.countries.length > 0) {
            params.append("countries", currentFilters.countries.join(","));
          }

          params.append("sort", currentFilters.sort);
          url += `?${params.toString()}`;

          const res = await fetch(url);
          const products = await res.json();
          productGrid.innerHTML = "";

          products.forEach((product) => {
            const price = product.packagingUnits?.[0]?.price || 0;
            const unit = product.packagingUnits?.[0]?.unitName || "";
            const isPrescription = product.isPrescription || false;

            const card = document.createElement("div");
            card.className = "search-card";

            card.innerHTML = `
            <a href="product-detail.html?id=${
              product._id || product.id
            }" class="product-link">
              <div class="product-image">
                <img src="${
                  product.images || "https://via.placeholder.com/200x200"
                }" alt="${product.name}" />
              </div>
              <div class="product-info">
                <h3>${product.name}</h3>
                <p class="price">${price.toLocaleString(
                  "vi-VN"
                )}đ / <span>${unit}</span></p>
              </div>
            </a>
            ${
              isPrescription
                ? `<button class="consult-button">Cần tư vấn từ dược sỹ</button>`
                : `<button class="add-to-cart" data-product-id="${
                    product._id || product.id
                  }">Chọn mua</button>`
            }
          `;
            productGrid.appendChild(card);
          });
        }

        // Xử lý sự kiện click cho các nút sắp xếp
        sortButtons.forEach((button) => {
          button.addEventListener("click", function () {
            // Xóa class active từ tất cả các nút
            sortButtons.forEach((btn) => btn.classList.remove("active"));
            // Thêm class active cho nút được click
            this.classList.add("active");
            // Cập nhật giá trị sắp xếp
            currentFilters.sort = this.dataset.sort;
            loadProducts();
          });
        });

        // Load mặc định
        document.querySelectorAll('input[name="medicine-type"]').forEach((r) =>
          r.addEventListener("change", function () {
            currentFilters.medicineType = this.value;
            loadProducts();
          })
        );

        document.querySelectorAll('input[name="price-range"]').forEach((r) =>
          r.addEventListener("change", function () {
            currentFilters.priceRange = this.value;
            loadProducts();
          })
        );

        await loadManufacturers();
        await loadProducts();
      });

      productGrid.addEventListener("click", async (event) => {
        if (event.target.classList.contains("add-to-cart")) {
          const productId = event.target.getAttribute("data-product-id");
          const userId = JSON.parse(localStorage.getItem("user"))?._id
          const unitName = event.target.closest(".search-card").querySelector(".product-info span").textContent;
          const quantity = 1; // Số lượng mặc định là 1

          if (!userId) {
            alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.");
            return;
          }
          
          //POST dữ liệu lên API
          const res = await fetch("http://localhost:5000/api/cart", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ user:userId, product:productId, unitName, quantity }),
          });
          const product = await res.json();
          console.log("Sản phẩm đã chọn:", product);

          loadCartInfoFromAPIToHeader(); // Cập nhật giỏ hàng trên header
        }
      });
    </script>
  </body>
</html>
