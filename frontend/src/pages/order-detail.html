<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link type="image/x-icon" href="../assets/img/logo.png" rel="shortcut icon" />
    <title>Chi ti·∫øt ƒë∆°n h√†ng</title>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      /* CSS gi·ªØ nguy√™n nh∆∞ b·∫°n g·ª≠i */
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
      }
      .container {
        width: 80%;
        margin: 20px auto;
      }
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin: 20px 0;
      }
      .status {
        color: green;
        font-weight: bold;
      }
      .order-info,
      .shipping-info,
      .payment-info {
        margin-top: 15px;
        padding: 10px;
        background: #fff;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
      }
      .order-info p,
      .shipping-info p,
      .payment-info p {
        margin: 5px 0;
      }
      .order-items {
        margin-top: 15px;
      }
      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #fff;
        border-bottom: 1px solid #ddd;
      }
      .item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
      }
      .item-info {
        flex: 1;
        margin-left: 15px;
      }
      .item-price {
        font-weight: bold;
      }
      .total {
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
      }
      .total p {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
      }
      .buy-again {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 10px;
      }
      .buy-again:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div data-include="../components/header.html"></div>

    <div class="container" id="order-detail">
      <p>ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng...</p>
    </div>

    <div data-include="../components/footer.html"></div>

    <script src="../assets/js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const container = document.getElementById("order-detail");

        const params = new URLSearchParams(window.location.search);
        const orderId = params.get("id");

        if (!orderId) {
          container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng.</p>";
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:5000/api/orders/${orderId}`,
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          );

          if (!res.ok) throw new Error("L·ªói khi t·∫£i ƒë∆°n h√†ng");

          const order = await res.json();
          console.log("order.user:", order.user);


          const createdAt = new Date(order.createdAt).toLocaleString("vi-VN");
          const orderCode = order._id.slice(-6).toUpperCase();
          const status = order.status || "ƒêang x·ª≠ l√Ω";
          const receiver = order.user?.name || "Kh√¥ng r√µ";
          const phone = order.phoneNumber || "N/A";
          const address = order.shippingAddress || "Ch∆∞a c·∫≠p nh·∫≠t";
          const paymentMethod = order.paymentMethod || "Ch∆∞a ch·ªçn";
          const total = order.totalPrice || 0;

          const itemsHTML = order.orderItems
            .map((item) => {
              const product = item.product || {};
              const name = product.name || "S·∫£n ph·∫©m";
              const image = product.image || "../assets/img/no_image.png";
              const quantity = item.items?.[0]?.quantity || 1;
              const price = item.items?.[0]?.price || 0;
              const unit = item.items?.[0]?.unitName || "";
              const subtotal = item.subtotal || price * quantity;

              return `
                <div class="item">
                  <img src="${image}" alt="${name}">
                  <div class="item-info">
                    <p><strong>${name}</strong></p>
                    <p>${price.toLocaleString()}ƒë x ${quantity} ${unit}</p>
                  </div>
                  <span class="item-price">${subtotal.toLocaleString()}ƒë</span>
                </div>
              `;
            })
            .join("");

          container.innerHTML = `
            <div class="order-header">
              <span>üìÖ M√£ ƒë∆°n h√†ng: ${orderCode}</span>
              <span class="status">‚úÖ ${status}</span>
            </div>

            <div class="order-info">
              <p><strong>Ng√†y ƒë·∫∑t:</strong> ${createdAt}</p>
              <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${paymentMethod}</p>
            </div>

            <div class="shipping-info">
              <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${receiver}</p>
              <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${phone}</p>
              <p><strong>ƒê·ªãa ch·ªâ:</strong> ${address}</p>
            </div>

            <div class="order-items">
              ${itemsHTML}
            </div>

            <div class="total">
              <p><span>T·∫°m t√≠nh:</span> <span>${total.toLocaleString()}ƒë</span></p>
              <p><span>Ph√≠ v·∫≠n chuy·ªÉn:</span> <span>Mi·ªÖn ph√≠</span></p>
              <p><span>T·ªïng c·ªông:</span> <span>${total.toLocaleString()}ƒë</span></p>
            </div>

            <button class="buy-again">üõí Mua l·∫°i</button>
          `;
        } catch (err) {
          console.error(err);
          container.innerHTML = "<p>Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        }
      });
    </script>
  </body>
</html>
